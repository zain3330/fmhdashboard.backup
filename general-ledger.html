<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPD Count</title>
    <script src="auth-check.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.min.js"></script>


    <script src="department-options.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#ce000b',
                    },
                },
            },
        }
    </script>
    <style>
        @keyframes progress {
            0% { width: 0; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        .animate-progress {
            animation: progress 2s ease-in-out infinite;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-... your_hash ..." crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>


<body class="bg-gray-100">
<!-- First, add this modal/loader HTML at the end of your body tag -->
<div id="loader" class="fixed inset-0 bg-gray-900/70 hidden z-50">
    <div class="flex min-h-screen items-center justify-center">
        <div class="relative bg-white rounded-lg p-8 max-w-sm w-full mx-4 shadow-xl">
            <!-- Loading Animation -->
            <div class="flex flex-col items-center">
                <!-- Animated Progress Bar -->
                <div class="w-full h-1.5 bg-gray-200 rounded-full mb-4 overflow-hidden">
                    <div class="h-full bg-gray-900 rounded-full animate-progress"></div>
                </div>

                <!-- Spinning Icon -->
                <div class="mb-4">
                    <i class="fas fa-file-excel text-gray-900 text-3xl animate-bounce"></i>
                </div>

                <!-- Loading Text -->
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Preparing Your Download</h3>
                <p class="text-gray-600 text-center text-sm">Please wait while we generate your Debtor Aging Master report...</p>
            </div>
        </div>
    </div>
</div>



<div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="bg-gray-900 text-white sidebar-transition w-64 min-h-screen overflow-y-auto max-h-screen">

        <div class="p-4 flex justify-between items-center">
            <h1 id="userName" class="text-center text-2xl font-bold sidebar-text"></h1>
            <div id="userInitials" class="text-center text-2xl font-bold  rounded-full bg-blue-500 flex items-center justify-center hidden"></div>

            <button id="toggleSidebar" onclick="toggleSidebar()" class="text-white p-2 rounded-full hover:bg-gray-700 transition-colors duration-200">
                <i class="fas fa-chevron-left sidebar-icon"></i>
            </button>
        </div>
        <nav class="mt-6">
            <a href="home.html" class="w-full flex items-center py-2 px-4 text-sm hover:bg-gray-700 transition-colors duration-200">
        <span class="flex items-center">
            <i class="fas fa-tachometer-alt w-5 h-5 mr-2"></i>
            <span class="sidebar-text">Dashboard</span>
        </span>
            </a>
            <div class="relative">
                <button onclick="toggleDropdown('Clinical')" class="w-full flex items-center justify-between py-2 px-4 text-sm hover:bg-gray-700 transition-colors duration-200">
                        <span class="flex items-center">
                            <i class="fas fa-stethoscope w-5 h-5 mr-2"></i>
                            <span class="sidebar-text">Clinical</span>
                        </span>
                    <i class="fas fa-chevron-down w-4 h-4"></i>
                </button>
                <div id="Clinical-dropdown" class="hidden bg-gray-800 py-2">
                    <!-- Dropdown items will be inserted here by JavaScript -->
                </div>
            </div>


        </nav>
    </aside>
    <main class="flex-1 overflow-y-auto bg-gray-100">
        <!-- Main Content -->
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-8xl mx-auto  p-4 flex justify-between items-center">
                <div class="flex items-center space-x-4">

                    <button onclick="toggleSidebar()" class="p-2 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        <i class="fas fa-bars w-6 h-6"></i>
                    </button>
                    <h2 id="departmentTitle" class="text-2xl font-bold text-gray-900">General Ledger</h2>
                </div>

                <div class="flex items-center space-x-4">

                    <button onclick="logout()" class="flex items-center space-x-2 bg-gray-900 hover:bg-gray-800 text-white px-4 py-2 rounded-md transition duration-200">
                        <i class="fas fa-sign-out-alt w-4 h-4"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                        <div class="bg-white rounded-lg shadow px-5 py-6 sm:px-6">
                            <div class="space-y-6">
                                <!-- Entity and Date Range Section -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label for="entity" class="block text-sm font-medium text-gray-700">Entity</label>
                                        <div class="relative mt-1">
                                            <select
                                                    id="entity"
                                                    name="entity"
                                                    class="block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md appearance-none"
                                            >
                                                <option value="11">FMH</option>
                                                <option value="12">FMDH</option>
                                                <option value="13">FMHCM</option>
                                                <option value="14">FMHCD</option>
                                                <option value="15">SWCON</option>
                                                <option value="16">IAHS</option>
                                                <option value="17">NIU</option>
                                                <option value="18">NUF</option>
                                                <option value="19">ABNI</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="startDate" class="block text-sm font-medium text-gray-700">Start Date</label>
                                        <input type="date" id="startDate" name="startDate"
                                               class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    </div>
                                    <div>
                                        <label for="endDate" class="block text-sm font-medium text-gray-700">End Date</label>
                                        <input type="date" id="endDate" name="endDate"
                                               class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    </div>
                                </div>

                                <!-- Chart of Code Section -->
                                <div class="space-y-4">
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Chart of Account</label>
                                            <div class="mt-1 space-y-4">
                                                <!-- From Account -->
                                                <div class="flex items-center gap-2">
                                                    <label class="text-sm text-gray-500 w-12">From:</label>
                                                    <div class="flex-1 relative"> <!-- Added relative positioning -->
                                                        <input
                                                                type="text"
                                                                id="chartCodeFromSearch"
                                                                placeholder="Enter code..."
                                                                class="block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                                                        />
                                                        <div id="chartCodeFromDropdown" class="absolute left-0 right-0 z-10 mt-1 bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm hidden">
                                                            <!-- Dropdown items will be populated here -->
                                                        </div>
                                                    </div>
                                                    <input
                                                            type="text"
                                                            id="chartCodeFromDesc"
                                                            placeholder="Description"
                                                            disabled
                                                            class="flex-1 block w-full pl-3 pr-3 py-2 text-base bg-gray-50 border border-gray-300 text-gray-500 sm:text-sm rounded-md"
                                                    />
                                                </div>

                                                <!-- To Account -->
                                                <div class="flex items-center gap-2">
                                                    <label class="text-sm text-gray-500 w-12">To:</label>
                                                    <div class="flex-1 relative"> <!-- Added relative positioning -->
                                                        <input
                                                                type="text"
                                                                id="chartCodeToSearch"
                                                                placeholder="Enter code..."
                                                                class="block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                                                        />
                                                        <div id="chartCodeToDropdown" class="absolute left-0 right-0 z-10 mt-1 bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm hidden">
                                                            <!-- Dropdown items will be populated here -->
                                                        </div>
                                                    </div>
                                                    <input
                                                            type="text"
                                                            id="chartCodeToDesc"
                                                            placeholder="Description"
                                                            disabled
                                                            class="flex-1 block w-full pl-3 pr-3 py-2 text-base bg-gray-50 border border-gray-300 text-gray-500 sm:text-sm rounded-md"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex justify-between items-center pt-4">
                                    <button id="resetButton"
                                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                                        Reset
                                    </button>
                                    <button id="downloadButton"
                                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-download inline-block w-4 h-4 mr-2"></i>
                                        Download Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


</div>
</main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let chartOfAccountsData = [];
        let uniqueCodesMap = new Map(); // To store unique codes

        // Load CSV data
        loadCSVData();

        function loadCSVData() {
            fetch('json/codes.csv')
                .then(response => response.text())
                .then(data => {
                    const parsedData = Papa.parse(data, {
                        header: true,
                        skipEmptyLines: true
                    });

                    // Process data to get unique codes
                    parsedData.data.forEach(item => {
                        if (!uniqueCodesMap.has(item.COA_CODE)) {
                            uniqueCodesMap.set(item.COA_CODE, item);
                        }
                    });

                    // Convert map to array
                    chartOfAccountsData = Array.from(uniqueCodesMap.values());

                    // Sort by COA_CODE
                    chartOfAccountsData.sort((a, b) => a.COA_CODE.localeCompare(b.COA_CODE));

                    setupSearchDropdowns();
                })
                .catch(error => console.error('Error loading CSV:', error));
        }

        function setupSearchDropdowns() {
            setupDropdown('chartCodeFrom');
            setupDropdown('chartCodeTo');
        }

        function setupDropdown(baseId) {
            const searchInput = document.getElementById(`${baseId}Search`);
            const dropdown = document.getElementById(`${baseId}Dropdown`);
            const descInput = document.getElementById(`${baseId}Desc`);
            const entitySelect = document.getElementById('entity');

            // Function to get entity prefix
            function getEntityPrefix(entityValue) {
                const prefixMap = {
                    '11': '11', // FMH
                    '12': '12', // FMDH
                    '13': '13', // FMHCM
                    '14': '14', // FMHCD
                    '15': '15', // SWCON
                    '16': '16', // IAHS
                    '17': '17', // NIU
                    '18': '18', // NUF
                    '19': '19'  // ABNI
                };
                return prefixMap[entityValue] || '11'; // Default to '11' if not found
            }

            // Function to filter data based on entity
            function getFilteredData() {
                const entityPrefix = getEntityPrefix(entitySelect.value);
                return chartOfAccountsData.filter(item =>
                    item.COA_CODE.startsWith(entityPrefix)
                );
            }

            // Clear description when input is cleared
            searchInput.addEventListener('input', (e) => {
                if (!e.target.value) {
                    descInput.value = ''; // Clear description when input is empty
                }
                const searchTerm = e.target.value.toLowerCase();
                filterCodes(searchTerm);
            });

            // Show filtered codes initially on focus
            searchInput.addEventListener('focus', () => {
                showFilteredCodes();
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest(`#${baseId}Search`) && !e.target.closest(`#${baseId}Dropdown`)) {
                    dropdown.classList.add('hidden');
                }
            });

            // Listen for entity changes
            entitySelect.addEventListener('change', () => {
                // Clear inputs when entity changes
                searchInput.value = '';
                descInput.value = '';
                if (dropdown.classList.contains('hidden')) {
                    return; // Don't show dropdown if it's currently hidden
                }
                showFilteredCodes();
            });

            function showFilteredCodes() {
                const filteredData = getFilteredData();
                renderDropdown(filteredData);
                dropdown.classList.remove('hidden');
            }

            function filterCodes(searchTerm) {
                const filteredByEntity = getFilteredData();
                const filtered = filteredByEntity.filter(item =>
                    item.COA_CODE.toLowerCase().includes(searchTerm) ||
                    item.COA_DESCRIPTION.toLowerCase().includes(searchTerm)
                );
                renderDropdown(filtered);
            }

            function renderDropdown(items) {
                if (items.length > 0) {
                    dropdown.innerHTML = items.map(item => `
                <div class="dropdown-item" data-code="${item.COA_CODE}" data-description="${item.COA_DESCRIPTION}">
                    <div class="font-medium">${item.COA_CODE}</div>
                    <div class="text-sm text-gray-500">${item.COA_DESCRIPTION}</div>
                </div>
            `).join('');

                    // Add click handlers to dropdown items
                    dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const code = item.dataset.code;
                            const description = item.dataset.description;

                            searchInput.value = code;
                            descInput.value = description;
                            dropdown.classList.add('hidden');
                        });
                    });

                    dropdown.classList.remove('hidden');
                } else {
                    dropdown.classList.add('hidden');
                }
            }
        }
        async function downloadData() {
            const startDateInput = document.getElementById("startDate");
            const endDateInput = document.getElementById("endDate");
            const loader = document.getElementById("loader");
            const chartCodeFromSearch = document.getElementById("chartCodeFromSearch");
            const chartCodeToSearch = document.getElementById("chartCodeToSearch");
            const downloadButton = document.getElementById("downloadButton");

            // Validation
            if (!startDateInput.value || !endDateInput.value) {
                showAlert("Please enter both the start and end dates.");
                return;
            }

// Check if chart codes are provided
            if (!chartCodeFromSearch.value && !chartCodeToSearch.value) {
                showAlert("Please enter both 'From' and 'To' chart codes before downloading.");
                return;
            }

// Optional: Additional validation if one code is entered without the other
            if ((chartCodeFromSearch.value && !chartCodeToSearch.value) ||
                (!chartCodeFromSearch.value && chartCodeToSearch.value)) {
                showAlert("Please enter both the 'From' and 'To' chart codes .");
                return;
            }
            // Disable button and show loading state
            downloadButton.disabled = true;
            downloadButton.innerHTML = '<span class="animate-pulse">Downloading...</span>';
            if (loader) loader.classList.remove("hidden");

            // Prepare end date
            let endDate = endDateInput.value;
            const endDateObj = new Date(endDate);
            endDateObj.setDate(endDateObj.getDate() + 1);
            endDate = endDateObj.toISOString().split("T")[0];

            const requestBody = {
                startDate: startDateInput.value,
                endDate: endDate,
                coa_short: document.getElementById("entity").value,
                coa_code_start: chartCodeFromSearch.value,
                coa_code_end: chartCodeToSearch.value
            };

            try {
                const response = await fetch("https://prod-00.northeurope.logic.azure.com:443/workflows/50d6bd6cf4b34fe69a7c8f51b60b8bf0/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ZwX8DFPCREggxbp494mnA4sZjAVurg9D4QFZy8Ig8Ps", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(requestBody),
                });

                if (!response.ok) throw new Error("Network response was not ok");

                const data = await response.json();

                // Prepare worksheet data
                const worksheetData = data.map((item) => {
                    const dateTime = item.TRANS_DATE.split('T');
                    const date = dateTime[0];
                    const time = dateTime[1]?.split('.')[0] || '';

                    return [
                        item.VOUCHER_TYPE || '',
                        item.VOUCHER_NO || '',
                        `${date}`.trim(),
                        item.CHEQUE_NO || '',
                        item.VOUCHER_REMARKS || '',
                        item.COA_CODE || '',
                        item.COA_DESCRIPTION || '',
                        item.LEDGER_TYPE_CODE || '',
                        item.SUB_LDGR_ITEM_CODE || '',
                        item.SUB_LDGR_ITEM_DESC || '',
                        item.NARRATION || '',
                        item.DR_AMOUNT || 0,
                        item.CR_AMOUNT || 0,
                    ];
                });

                // Create worksheet
                const worksheet = XLSX.utils.aoa_to_sheet([
                    [
                        "Voucher Type",
                        "Voucher No",
                        "Transaction Date",
                        "Cheque No",
                        "Voucher Remarks",
                        "COA Code",
                        "COA Description",
                        "Ledger Type Code",
                        "Sub Ledger Code",
                        "Sub Ledger Description",
                        "Narration",
                        "Debit Amount",
                        "Credit Amount"
                    ],
                    ...worksheetData,
                ]);

                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(
                    workbook,
                    worksheet,
                    "General Ledger Data"
                );
                XLSX.writeFile(
                    workbook,
                    `general_ledger_${startDateInput.value}_to_${endDateInput.value}.xlsx`
                );
                showSuccessMessage();
            } catch (error) {
                console.error("Failed to fetch data:", error);
                showErrorMessage();
            } finally {
                if (loader) loader.classList.add("hidden");
                downloadButton.disabled = false;
                downloadButton.innerHTML = '<i class="fas fa-download inline-block w-4 h-4 mr-2"></i>Download Data';
            }
        }

        // Add click handler for download button
        document.getElementById('downloadButton').addEventListener('click', downloadData);
        // Reset functionality
        document.getElementById('resetButton').addEventListener('click', function() {
            document.getElementById('entity').value = '11';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';

            ['From', 'To'].forEach(section => {
                document.getElementById(`chartCode${section}Search`).value = '';
                document.getElementById(`chartCode${section}Desc`).value = '';
            });

            // Hide dropdowns
            document.getElementById('chartCodeFromDropdown').classList.add('hidden');
            document.getElementById('chartCodeToDropdown').classList.add('hidden');
        });
    });
    function showAlert(title, message) {
        const modal = document.getElementById("alertModal")
        const titleElement = document.getElementById("alertTitle")
        const messageElement = document.getElementById("alertMessage")

        titleElement.textContent = title
        messageElement.textContent = message
        modal.classList.remove("hidden")
    }

    function hideAlert() {
        const modal = document.getElementById("alertModal")
        modal.classList.add("hidden")
    }

    document.getElementById("closeModal").addEventListener("click", hideAlert)







</script>


<script>



    function createDropdownItems(options, parentId = '') {
        const fragment = document.createDocumentFragment();

        options.forEach(option => {
            if (option.submenu) {
                // Create submenu container
                const submenuContainer = document.createElement('div');
                submenuContainer.className = 'relative';

                // Create submenu button
                const submenuButton = document.createElement('button');
                submenuButton.className = 'w-full flex items-center justify-between py-2 px-4 text-sm text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200';
                submenuButton.setAttribute('data-submenu', `${parentId}-${option.name.replace(/\s+/g, '-').toLowerCase()}`);
                submenuButton.innerHTML = `
                    <span class="flex items-center">
                        <i class="fas ${option.icon} w-4 h-4 mr-2"></i>
                        <span class="sidebar-text">${option.name}</span>
                    </span>
                    <i class="fas fa-chevron-right w-4 h-4 transition-transform duration-200"></i>
                `;

                // Create submenu content
                const submenuContent = document.createElement('div');
                submenuContent.id = `${parentId}-${option.name.replace(/\s+/g, '-').toLowerCase()}-submenu`;
                submenuContent.className = 'hidden pl-4 bg-gray-800/50';

                // Add submenu items recursively
                submenuContent.appendChild(createDropdownItems(option.submenu, submenuContent.id));

                // Add click handler
                submenuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    submenuContent.classList.toggle('hidden');
                    submenuButton.querySelector('.fa-chevron-right').classList.toggle('rotate-90');
                    saveSidebarState();
                });

                submenuContainer.appendChild(submenuButton);
                submenuContainer.appendChild(submenuContent);
                fragment.appendChild(submenuContainer);
            } else {
                // Create regular menu item
                const link = document.createElement('a');
                link.href = option.link;
                link.className = 'block py-2 px-4 text-sm text-gray-300 hover:bg-gray-700 hover:text-white transition-colors duration-200';
                link.innerHTML = `
                    <span class="flex items-center">
                        <i class="fas ${option.icon} w-4 h-4 mr-2"></i>
                        <span class="sidebar-text">${option.name}</span>
                    </span>
                `;
                fragment.appendChild(link);
            }
        });

        return fragment;
    }

    for (const [department, options] of Object.entries(departmentOptions)) {
        const dropdown = document.getElementById(`${department}-dropdown`);
        dropdown.appendChild(createDropdownItems(options, department));
    }
    // Add CSS for submenu animations
    const style = document.createElement('style');
    style.textContent = `
        .rotate-90 {
            transform: rotate(90deg);
        }
        [data-submenu] .fa-chevron-right {
            transition: transform 0.2s ease-in-out;
        }
    `;
    document.head.appendChild(style);

    // Update toggleSidebar to handle submenu text
    function toggleSidebar() {
        isOpen = !isOpen;
        sidebar.classList.toggle('w-64');
        sidebar.classList.toggle('w-24');

        // Toggle all text elements in sidebar
        document.querySelectorAll('.sidebar-text').forEach(el => {
            el.classList.toggle('hidden');
        });

        // Toggle username and initials
        if (isOpen) {
            userName.classList.remove('hidden');
            userInitials.classList.add('hidden');
        } else {
            userName.classList.add('hidden');
            userInitials.classList.remove('hidden');
        }

        saveSidebarState();
    }

    function toggleDropdown(id) {
        const dropdown = document.getElementById(`${id}-dropdown`);
        const chevron = document.querySelector(`button[onclick="toggleDropdown('${id}')"] .fa-chevron-down`);

        // Toggle only the clicked dropdown without affecting others
        dropdown.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
        saveSidebarState();
    }
    function saveSidebarState() {
        const openMenus = Array.from(document.querySelectorAll('[id$="-dropdown"], [id$="-submenu"]'))
            .filter(el => !el.classList.contains('hidden'))
            .map(el => el.id);

        localStorage.setItem('sidebarState', JSON.stringify({
            isOpen,
            openMenus
        }));
    }

    // Update loadSidebarState to handle submenus
    function loadSidebarState() {
        const savedState = localStorage.getItem('sidebarState');
        if (savedState) {
            const { isOpen: savedIsOpen, openMenus } = JSON.parse(savedState);
            if (!savedIsOpen) toggleSidebar();

            openMenus.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.remove('hidden');
                    // Rotate chevron if it's a submenu
                    const button = document.querySelector(`[data-submenu="${id.replace('-submenu', '')}"]`);
                    if (button) {
                        button.querySelector('.fa-chevron-right').classList.add('rotate-90');
                    }
                }
            });
        }
    }


    function getInitials(name) {
        return name.split(' ').map(n => n[0]).join('').toUpperCase();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const fullName = localStorage.getItem('fullName');
        if (fullName) {
            userName.textContent = fullName;
            userInitials.textContent = getInitials(fullName);
        }
        loadSidebarState();

        // Only keep the sidebar toggle functionality
        sidebar.addEventListener('click', function(event) {
            if (event.target === sidebar) {
                toggleSidebar();
            }
        });
    });

    // Highlight current page in sidebar
    const currentPage = window.location.pathname.split('/').pop();
    const currentLink = document.querySelector(`a[href="${currentPage}"]`);
    if (currentLink) {
        currentLink.classList.add('bg-gray-700', 'text-white');
    }
    function logout() {
        localStorage.removeItem('isLoggedIn');
        window.location.href = 'index.html';
    }


    document.addEventListener('click', function(event) {
        if (!event.target.closest('.relative')) {
            document.querySelectorAll('[id$="-dropdown"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.fa-chevron-right').forEach(el => el.style.transform = 'rotate(0deg)');
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        const userNameElement = document.getElementById('userName');
        const fullName = localStorage.getItem('fullName');
        if (fullName) {
            userNameElement.textContent = `${fullName}`;
        }
    });

    // Make sure this event listener is set up
    document.addEventListener("DOMContentLoaded", () => {
        // ... existing DOMContentLoaded logic ...

        // Add this line to ensure the closeModal button is properly set up
        document.getElementById("closeModal").addEventListener("click", hideAlert)
    })
    // Entity data structure
    const entities = [
        { value: '11', label: 'FMH' },
        { value: '12', label: 'FMDH' },
        { value: '13', label: 'FMHCM' },
        { value: '14', label: 'FMHCD' },
        { value: '15', label: 'SWCON' },
        { value: '16', label: 'IAHS' },
        { value: '17', label: 'NIU' },
        { value: '18', label: 'NUF' },
        { value: '19', label: 'ABNI' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('entitySearch');
        const dropdown = document.getElementById('entityDropdown');
        const select = document.getElementById('entity');

        // Set initial value
        const initialEntity = entities.find(e => e.value === select.value);
        if (initialEntity) {
            searchInput.value = initialEntity.label;
        }

        function createDropdownItems(filterText = '') {
            const filteredEntities = entities.filter(entity =>
                entity.label.toLowerCase().includes(filterText.toLowerCase()) ||
                entity.value.includes(filterText)
            );

            dropdown.innerHTML = filteredEntities.map(entity => `
            <div
                class="entity-option cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-gray-50 ${select.value === entity.value ? 'bg-indigo-50' : ''}"
                data-value="${entity.value}"
            >
                <div class="flex items-center">
                    <span class="font-normal block truncate ${select.value === entity.value ? 'font-semibold text-indigo-600' : 'text-gray-900'}">
                        ${entity.label}
                    </span>
                </div>
                ${select.value === entity.value ? `
                    <span class="absolute inset-y-0 right-0 flex items-center pr-4 text-indigo-600">
                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </span>
                ` : ''}
            </div>
        `).join('');

            // Add click handlers to options
            document.querySelectorAll('.entity-option').forEach(option => {
                option.addEventListener('click', () => {
                    const value = option.dataset.value;
                    const entity = entities.find(e => e.value === value);
                    select.value = value;
                    searchInput.value = entity.label;
                    dropdown.classList.add('hidden');
                    // Trigger change event
                    select.dispatchEvent(new Event('change'));
                });
            });
        }

        // Show dropdown on input focus
        searchInput.addEventListener('focus', () => {
            createDropdownItems(searchInput.value);
            dropdown.classList.remove('hidden');
        });

        // Filter on input
        searchInput.addEventListener('input', (e) => {
            createDropdownItems(e.target.value);
            dropdown.classList.remove('hidden');
        });

        // Handle keyboard navigation
        searchInput.addEventListener('keydown', (e) => {
            const options = dropdown.querySelectorAll('.entity-option');
            const currentIndex = Array.from(options).findIndex(option =>
                option.dataset.value === select.value
            );

            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (currentIndex < options.length - 1) {
                        options[currentIndex + 1].click();
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    if (currentIndex > 0) {
                        options[currentIndex - 1].click();
                    }
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (!dropdown.classList.contains('hidden')) {
                        dropdown.classList.add('hidden');
                    }
                    break;
                case 'Escape':
                    e.preventDefault();
                    dropdown.classList.add('hidden');
                    break;
            }
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                dropdown.classList.add('hidden');
            }
        });

        // Initialize dropdown items
        createDropdownItems();
    });

    // Success Message Function
    function showSuccessMessage() {
        const successModal = document.createElement('div');
        successModal.className = 'fixed inset-0 bg-gray-900/70 flex items-center justify-center z-50';
        successModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 shadow-xl">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-green-500 text-3xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Download Complete!</h3>
                <p class="text-gray-600 mb-4">Your report has been successfully downloaded.</p>
                <button onclick="this.closest('div.fixed').remove()"
                        class="bg-gray-900 text-white px-4 py-2 rounded-md hover:bg-gray-800 transition-colors">
                    Close
                </button>
            </div>
        </div>
    `;
        document.body.appendChild(successModal);
        setTimeout(() => successModal.remove(), 3000); // Auto remove after 3 seconds
    }

    // Error Message Function
    function showErrorMessage() {
        const errorModal = document.createElement('div');
        errorModal.className = 'fixed inset-0 bg-gray-900/70 flex items-center justify-center z-50';
        errorModal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 shadow-xl">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-3xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Download Failed</h3>
                <p class="text-gray-600 mb-4">There was an error downloading your report. Please try again.</p>
                <button onclick="this.closest('div.fixed').remove()"
                        class="bg-gray-900 text-white px-4 py-2 rounded-md hover:bg-gray-800 transition-colors">
                    Close
                </button>
            </div>
        </div>
    `;
        document.body.appendChild(errorModal);
    }

</script>


</body>
<div id="alertModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 overflow-y-auto h-full w-full hidden flex items-center justify-center">
    <div class="relative p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-gray-900">
                <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-semibold text-gray-900 mt-5" id="alertTitle">Error</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-600" id="alertMessage"></p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="closeModal" class="px-4 py-2 bg-gray-900 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400">
                    OK
                </button>
            </div>
        </div>
    </div>
</div>






</html>